# 项目技术方案：Next.js + NestJS + Supabase

## 1. 项目目标

构建一个支持文档知识库 + RAG 问答 + PDF 精准溯源的 SaaS 产品，具备：

- 多用户与权限体系
    
- 文档上传、解析、向量化
    
- 基于 pgvector 的语义检索
    
- Chat 流式问答（Streaming）
    
- PDF 页面级高亮溯源
    
- BYOK（用户自带 API Key）
    
- Serverless 优先、低运维、可扩展
    

技术栈：**Next.js + NestJS + Supabase（Postgres / Storage / Auth / Realtime）**，不依赖 Redis。

---

## 2. 总体架构

```
Next.js (Frontend)
   ↓ REST / SSE / Supabase Client
NestJS API (Backend)
   ↓ Supabase SDK
Supabase (Postgres + pgvector + Storage + Auth + Realtime)
   ↓
NestJS Worker (Job Polling)
```

---

## 3. 技术选型与职责

### 前端（Next.js）

- 页面渲染：App Router

- UI 框架：Tailwind CSS + shadcn/ui

- 状态管理：Zustand

- 请求：fetch / React Query

- PDF 渲染：react-pdf

- 高亮：react-pdf-highlighter

- Streaming：SSE / Supabase Realtime
    

### 后端（NestJS）

- API Gateway
    
- Auth 与权限校验
    
- RAG Pipeline
    
- 文档处理调度
    
- 向量检索封装
    
- Worker 任务处理
    

### Supabase

- Auth：用户体系
    
- Postgres + pgvector：数据与向量
    
- Storage：文档文件
    
- Realtime：消息流
    
- Edge Functions（可选）：轻任务
    

---

## 4. 模块拆分

### Next.js

```
src/
 ├── app/
 ├── components/
 ├── hooks/
 ├── services/
 ├── stores/
 └── features/chat | pdf | kb
```

### NestJS

```
apps/api/
 ├── auth/
 ├── users/
 ├── api-keys/
 ├── knowledge-base/
 ├── documents/
 ├── chunks/
 ├── chat/
 ├── rag/
 ├── jobs/
 └── storage/

apps/worker/
 ├── job-runner/
 ├── parse/
 ├── embed/
 └── index/
```

---

## 5. 数据库设计（Supabase Postgres）

### users

```sql
id, email, plan, created_at
```

### knowledge_bases

```sql
id, user_id, name, created_at
```

### documents

```sql
id, kb_id, filename, status, page_count, created_at
```

### chunks（pgvector）

```sql
id uuid primary key,
kb_id uuid,
document_id uuid,
content text,
embedding vector(1536),
page_number int,
bbox jsonb,
created_at timestamp
```

### jobs（任务队列，无 Redis）

```sql
id uuid primary key,
type text,
payload jsonb,
status text default 'pending',
attempts int default 0,
run_at timestamp default now()
```

---

## 6. BYOK API Key 安全

- AES-256-GCM 加密存储
    
- Key 永不明文存 DB
    
- 请求时内存解密
    

NestJS Service：

```ts
@Injectable()
export class ApiKeyService {
  encrypt();
  decrypt();
  verify();
}
```

---

## 7. 文档处理 Pipeline（无 Redis）

### 流程

```
Upload → Supabase Storage
 → insert jobs(type='parse')
 → Worker poll → parse
 → insert jobs(type='embed')
 → embed → insert vector
```

### Job 拉取 SQL（并发安全）

```sql
UPDATE jobs
SET status='processing'
WHERE id=(
  SELECT id FROM jobs
  WHERE status='pending'
  ORDER BY run_at
  LIMIT 1
  FOR UPDATE SKIP LOCKED
)
RETURNING *;
```

---

## 8. PDF 解析（Node）

库：pdfjs-dist

提取 bbox：

```ts
item.transform → x,y,width,height
```

存储 bbox：

```json
{"x0":120,"y0":300,"x1":520,"y1":360}
```

---

## 9. RAG Pipeline（NestJS）

### Flow

```
User Query
 → embedding
 → pgvector search
 → topK chunks
 → prompt builder
 → LLM stream
```

### SQL

```sql
select * from chunks
order by embedding <=> :query
limit 5;
```

---

## 10. Chat Streaming

### NestJS SSE

```ts
@Sse('stream')
stream() { return observable; }
```

### Next.js

```ts
new EventSource('/api/chat/stream')
```

---

## 11. PDF 高亮（Next.js）

- 渲染：react-pdf
    
- 高亮：react-pdf-highlighter
    

坐标映射：

```ts
scaleX = renderWidth / originWidth
```

---

## 12. Supabase Storage

路径：

```
/user_id/kb_id/doc_id.pdf
```

生成 Signed URL

---

## 13. Rate Limit（无 Redis）

DB 滑窗：

```sql
count(*) where created_at > now() - interval '1 minute'
```

---

## 14. 安全策略

- Row Level Security（Supabase）
    
- JWT scope 校验
    
- Prompt 注入防护
    
- 文件类型校验
    

---

## 15. 部署

### Docker Compose

- web (Next.js)
    
- api (NestJS)
    
- worker (NestJS)
    

### Supabase 托管 DB + Storage

---

## 16. 性能天花板评估

|模块|预期规模|
|---|---|
|并发用户|1k–5k|
|文档总量|100k|
|RAG QPS|10–50|

---

## 17. 里程碑

### Sprint 1

- Auth + KB CRUD
    

### Sprint 2

- Upload + Jobs + Worker
    

### Sprint 3

- RAG + Chat
    

### Sprint 4

- PDF 高亮
    

---

## 18. 架构演进

当增长时可扩展：

- 外接 SQS / Upstash Queue
    
- GPU Embedding Worker
    
- Redis 可选补充
