# 产品需求文档 (PRD) - Note Plus  V1.0

| 文档属性     | 内容                     |
| -------- | ---------------------- |
| **产品名称** | Note Plus              |
| **版本号**  | V1.0 (MVP)             |
| **产品形态** | Web SaaS 平台            |
| **核心模式** | BYOK (用户自备 Key) + 免费开源 |
| **目标用户** | 深度研究者、学生、也兼容想自行部署的技术极客 |

---

## 1. 产品概述 (Overview)

### 1.1 核心价值

打造一个**云端可访问、完全开源**的个人知识库助手。用户无需配置环境，注册即可使用（SaaS模式），只需填入自己的 API Key，即可基于私有文档进行深度问答。同时支持一键 Docker 部署，满足数据绝对隐私需求。

### 1.2 商业与成本模式 (MVP策略)

- **平台方成本：** 仅承担基础 Web 服务器、数据库与对象存储流量费用。
- **用户方成本：** 用户需自行承担 LLM 推理费用 (OpenAI/Claude API)。
- **限制策略：** 为防止服务器存储滥用，SaaS 版限制单个账户最大上传文件数（如 50 个）或总容量（如 200MB）。

---

## 2. 系统架构与角色 (System Architecture)

### 2.1 双模架构 (关键设计)

为了同时满足 SaaS 和自部署，技术选型必须标准化：

- **SaaS 环境：** 官方托管。使用 PostgreSQL (元数据) + AWS S3 (文件存储) + 向量库 (PgVector/Chroma)。
- **Self-Host 环境：** 用户下载源码。使用 `docker-compose` 一键拉起所有服务，其中 S3 被 **MinIO** 替代，实现完全离线化。

### 2.2 用户角色

- **访客：** 仅浏览落地页，不可使用功能。
- **注册用户：** 需绑定邮箱。未配置 API Key 时，无法发起对话，但可管理知识库。

---

## 3. 业务流程 (User Flow)

mermaid

```
graph TD
    A[落地页] --> B[注册/登录]
    B --> C{检查API Key}
    C -- 未配置 --> D[设置页: 填写 OpenAI Key]
    C -- 已配置 --> E[知识库仪表盘]
    E --> F[新建知识库 & 上传文档]
    F --> G[进入对话界面]
    G --> H[提问 & 获取回答]
    H --> I[点击角标 -> 右侧分屏溯源]
```

---

## 4. 功能详情 (Functional Specifications)

### 4.1 模块一：账户与凭证管理 (BYOK 核心)

**优先级：P0**

- **API Key 设置：**
    - 位置：全局设置/顶部导航栏显眼位置。
    - 支持厂商：OpenAI (GPT-3.5/4), Moonshot (Kimi), Claude (可选)。
    - **Base URL 支持：** 允许用户修改接口地址（方便国内用户通过中转站调用 OpenAI）。
    - **验证逻辑：** 用户输入 Key 后，后台发一个极简请求（如 "Hi"）测试连通性，成功后加密存储至数据库。

### 4.2 模块二：云端知识库构建

**优先级：P0**

- **文件上传：**
    - 支持拖拽上传 PDF, MD, TXT, DOCX。
    - **云端处理：** 文件上传至对象存储（S3/MinIO） -> 触发后端解析任务 -> 文本切片 -> 调用 Embedding API（消耗用户的 Key） -> 存入向量库。
- **解析状态反馈：**
    - 由于走网络请求，必须提供清晰的状态机：`排队中` -> `解析中` -> `索引完成` -> `失败(附原因)`。

### 4.3 模块三：分屏对照 RAG 问答 (核心体验)

**优先级：P0**

- **界面布局：**
    - **左侧 (Chat)：** 聊天气泡流。
    - **右侧 (Source)：** PDF/文档阅读器（默认折叠，可展开）。
- **溯源高亮逻辑 (Highlighting)：**
    - **前提：** 解析层必须记录每个切片的 `page_number` 和 `bbox` (文本在页面上的坐标盒子)。
    - **交互：** 用户点击回答中的 `[1]`。
    - **响应：**
        1. 右侧加载该 PDF 文件（从 S3 获取临时访问链接）。
        2. 自动跳转到指定页码。
        3. **Canvas 绘制高亮：** 在对应坐标位置覆盖一层黄色半透明蒙层。

---

### 详细功能清单 (Feature List)

这份清单按优先级（P0-MVP必做，P1-体验优化）排序，是开发估时（Estimation）的直接依据。

#### 模块 A：用户与鉴权系统 (User & Auth)

|ID|功能名称|优先级|功能描述/验收标准|开发端备注|
|---|---|---|---|---|
|**A-01**|**邮箱注册/登录**|P0|支持邮箱+密码注册，JWT Token 鉴权。|NextAuth 或自定义 FastAPI 鉴权|
|**A-02**|**API Key 管理**|P0|用户可添加/修改/查看(脱敏) OpenAI 格式的 Key。支持自定义 Base URL。|需 AES 加密存储数据库|
|**A-03**|**Key 有效性验证**|P1|保存 Key 时，后端自动发起一次极简对话请求验证连通性。|避免用户填错 Key 导致后续报错|
|**A-04**|**配额限制**|P0|限制单用户最大知识库数量（如 5个）、单文件大小（10MB）。|防止 SaaS 存储成本失控|

#### 模块 B：知识库与文档 (Knowledge Base)

|ID|功能名称|优先级|功能描述/验收标准|开发端备注|
|---|---|---|---|---|
|**B-01**|**知识库 CRUD**|P0|创建、编辑名称、删除知识库（级联删除库内向量）。|逻辑隔离，Collection 概念|
|**B-02**|**多格式上传**|P0|支持 PDF, Markdown, TXT, Word。显示上传进度条。|前端限制文件类型|
|**B-03**|**文档解析引擎**|P0|后端异步解析。**必须保留 PDF 页面和坐标信息**。|推荐 `PyMuPDF` 或 `Unstructured`|
|**B-04**|**解析状态机**|P0|列表需显示状态：排队中 -> 解析中 -> 索引完成 -> 失败。|轮询或 WebSocket 更新状态|
|**B-05**|**切片调试 (Debug)**|P2|(高级功能) 点击文档可查看被切分成的 Chunk 列表。|方便排查检索不准的问题|

#### 模块 C：对话与溯源 (Chat & Source)

|ID|功能名称|优先级|功能描述/验收标准|开发端备注|
|---|---|---|---|---|
|**C-01**|**新建/历史会话**|P0|每个知识库下可有多个 Session，支持查看历史记录。|存储 ChatHistory 表|
|**C-02**|**流式对话**|P0|类似 ChatGPT 的打字机效果，降低等待焦虑。|Server-Sent Events (SSE)|
|**C-03**|**引用标注**|P0|LLM 回答中包含 `[n]`，且前端将其渲染为可点击链接。|Prompt 工程要求 LLM 严格格式|
|**C-04**|**PDF 阅读器**|P0|Web 端嵌入 PDF 阅读器，支持缩放、翻页。|`react-pdf`|
|**C-05**|**高亮跳转**|P0|**核心功能**。点击引用，阅读器跳转页码并在指定坐标画框。|需前端根据 BBox 计算相对位置|
|**C-06**|**引用源文本展示**|P1|如果是 TXT/MD 等无页码格式，点击引用展示纯文本片段。|降级处理方案|

#### 模块 D：运维与部署 (Ops)

| ID       | 功能名称          | 优先级 | 功能描述/验收标准                                         | 开发端备注             |
| -------- | ------------- | --- | ------------------------------------------------- | ----------------- |
| **D-01** | **Docker 编排** | P0  | 提供 `docker-compose.yml`，一键拉起 Web, API, DB, MinIO。 | 确保 Self-Host 用户可用 |
| **D-02** | **环境变量配置**    | P0  | 支持通过 .env 配置 S3 地址、DB 地址、是否开启注册等。                 |                   |
## 5. 技术方案建议 (Technical Stack)

为了支持 SaaS + 开源，推荐以下全栈方案：

- **前端：** Next.js (React) + TailwindCSS + shadcn/ui。
    - _UI 组件库：_ shadcn/ui (基于 Radix UI 的高质量 React 组件库，可定制性强)。
    - _PDF 渲染库：_ `react-pdf-highlighter` (专门解决 Web 端 PDF 高亮选中问题的库，强烈推荐)。
- **后端：** Python FastAPI。
    - _RAG 框架：_ LlamaIndex 或 LangChain (便于切换模型)。
- **数据库：**
    - _关系型：_ PostgreSQL (存用户、Key、文件元数据)。
    - _向量型：_ PgVector (直接作为 PG 插件使用，减少维护成本，只需要维护一个数据库)。
- **存储：** S3 协议兼容 (AWS S3 / MinIO)。

---

## 6. 开发与交付计划 (Roadmap)

### 第一阶段：核心闭环 (MVP)

1. **脚手架搭建：** 跑通 Next.js + FastAPI + Postgres 的 Docker 编排。
2. **BYOK 验证：** 实现用户填 Key 并成功调用 OpenAI 接口。
3. **RAG 基础：** 实现文件上传、S3 存储、基础问答。
4. **开源发布：** 整理 Readme，发布到 GitHub。

### 第二阶段：体验升级

1. **高亮溯源：** 攻克 `react-pdf-highlighter` 与后端坐标对齐的难点。
2. **流式输出 (Streaming)：** 让回答像打字机一样出来，而不是等全生成完再显示。

---

**@用户（产品负责人）：**  
这份文档已经适应了 **SaaS + BYOK + 开源** 的战略调整。

**主要风险提示：**

1. **Embedding 成本：** 虽然对话用了用户的 Key，但文档上传时需要“向量化”。通常这部分费用很低，**MVP 建议直接复用用户的 OpenAI Key 进行 Embedding**（需在前端提示用户：上传文档会消耗少量 Token）。
2. **网络问题：** 你的 SaaS 服务器部署在哪里？如果部署在国外，国内用户访问慢；如果部署在国内，调用 OpenAI 接口可能需要代理。**建议 MVP 服务器部署在香港或新加坡**，兼顾访问速度和 API 连通性。 

## 术语表 (Glossary)

|术语|解释|
|---|---|
|**BYOK**|Bring Your Own Key，用户自备 API 密钥，平台不承担推理费用|
|**RAG**|Retrieval-Augmented Generation，检索增强生成，先从文档中检索相关片段再交给大模型回答|
|**Chunk**|文档切片，将长文档按语义或固定长度拆分成的小段落，是检索的最小单位|
|**Embedding**|将文本转换为高维向量的过程，用于计算语义相似度|
|**BBox**|Bounding Box，文本在 PDF 页面上的坐标矩形框 (x0, y0, x1, y1)|
|**PgVector**|PostgreSQL 的向量检索插件，支持在关系型数据库中存储和查询向量|
|**SSE**|Server-Sent Events，服务端推送技术，用于实现流式输出（打字机效果）|
|**Presigned URL**|S3 预签名链接，带有限时访问权限的文件下载地址|
|**Rerank**|对初步检索结果进行二次精排，提升引用质量|

---

## 1. 产品概述 (Overview)

### 1.1 核心价值

打造一个**云端可访问、完全开源**的个人知识库助手。用户无需配置环境，注册即可使用（SaaS 模式），只需填入自己的 API Key，即可基于私有文档进行深度问答。同时支持一键 Docker 部署，满足数据绝对隐私需求。

**一句话定位：** 开箱即用的论文级 RAG 问答工具，精准溯源到页码和段落，让每一个回答都有据可查。

### 1.2 竞品分析与差异化

| 竞品             | 优势                                     | 劣势/我们的差异点                 |
| -------------- | -------------------------------------- | ------------------------- |
| **NotebookLM** | 多模态，应用类型丰富，支持网络导入文件                    | 无本地部署版                    |
| **ChatPDF**    | 即开即用                                   | 不支持 BYOK、不开源、单文档限制、无知识库管理 |
| **saner.ai**   | 使用门槛低，操作简单                             | 无坐标级高亮，功能较少               |
| **Note Plus**  | **SaaS 零门槛 + 开源自部署 + 分屏精准溯源（页码+坐标高亮）** | MVP 功能尚在建设                |

> **核心壁垒：** 分屏高亮溯源体验 —— 点击引用角标，右侧 PDF 阅读器自动跳转到对应页码并用黄色高亮框标注出具体段落位置。这是学术场景下"回答可信度"的关键支撑。

### 1.3 目标用户画像

#### 主力用户（MVP 聚焦）

| 维度       | 描述                                                    |
| -------- | ----------------------------------------------------- |
| **身份**   | 在读硕博研究生                                               |
| **典型场景** | 上传 10-30 篇英文/中文论文 PDF，围绕某个课题进行跨文档问答，需要快速定位原文出处以写入文献综述 |
| **痛点**   | 论文太多记不住哪篇写了什么；手动翻 PDF 找原文效率极低；ChatGPT 回答无法溯源          |
| **付费意愿** | 对免费产品有强偏好，但愿意为 API 调用付少量费用（每月 $2-5 的 OpenAI 费用可接受）    |
| **技术水平** | 会用 ChatGPT，但不会/不愿折腾 Docker 部署                         |

#### 次要用户

| 身份    | 场景         | 优先级        |
| ----- | ---------- | ---------- |
| 行业研究员 | 上传行业报告进行分析 | P1         |
| 技术极客  | 自行部署、二次开发  | P1（通过开源覆盖） |

### 1.4 商业与成本模式

- **平台方成本：** 仅承担基础 Web 服务器、数据库与对象存储流量费用。
- **用户方成本：** 用户自行承担 LLM 推理费用和 Embedding 费用（使用用户自己的 API Key）。
- **限制策略：** 防止存储滥用，详见下方配额表。

|限制项|SaaS 免费额度|Self-Host|
|---|---|---|
|知识库数量|5 个|无限制|
|单知识库文档数|20 个|无限制|
|单文件大小|10 MB|可配置|
|总存储容量|200 MB|无限制|
|支持文件格式|PDF, MD, TXT, DOCX|同左|

---

## 2. 系统架构 (System Architecture)

### 2.1 双模架构

| 组件     | SaaS 环境         | Self-Host 环境      |
| ------ | --------------- | ----------------- |
| Web 前端 | Vercel / 自有服务器  | Docker 容器         |
| API 后端 | 自有服务器（建议香港/新加坡） | Docker 容器         |
| 关系型数据库 | Supabase        | Docker PostgreSQL |
| 向量数据库  | PgVector        | Docker PgVector   |
| 文件存储   | Supabase        | Docker            |


### 2.2 系统架构图

```
┌─────────────────────────────────────────────────┐
│                   前端 (Next.js)                  │
│  ┌──────┐  ┌──────────┐  ┌───────────────────┐  │
│  │ 登录  │  │ 知识库管理 │  │ 对话 + PDF分屏阅读 │  │
│  └──────┘  └──────────┘  └───────────────────┘  │
└────────────────────┬────────────────────────────┘
                     │ HTTPS (JWT)
┌────────────────────▼────────────────────────────┐
│                后端 (FastAPI)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │
│  │ Auth 模块 │  │ RAG 引擎  │  │ 文件处理管道  │   │
│  └──────────┘  └──────────┘  └──────────────┘   │
│                      │                            │
│  ┌──────────────────▼────────────────────────┐   │                
│  │   文档解析 → 切片 → Embedding → 入库        │   │
│  └───────────────────────────────────────────┘   │
└──────┬──────────────┬────────────────┬───────────┘
       │              │                │
  ┌────▼────┐  ┌──────▼──────┐  ┌─────▼─────┐
  │PostgreSQL│  │  PgVector   │  │ Supabase │
  │ 元数据   │  │  向量检索   │  │  文件存储  │
  └─────────┘  └─────────────┘  └───────────┘
```

### 2.3 用户角色与权限

| 角色              | 能力            | 限制                       |
| --------------- | ------------- | ------------------------ |
| **访客**          | 浏览产品官网、查看产品介绍 | 不可使用任何功能                 |
| **注册用户（无 Key）** | 创建知识库         | 不可上传（需 Embedding）、不可发起对话 |
| **注册用户（有 Key）** | 全部功能          | 受配额限制                    |

> **注意：** 上传文件时需要调用 Embedding API，因此未配置 Key 的用户连上传也无法完成。前端需在上传入口给出提示。

---

## 3. 数据模型 (Data Model)

### 3.1 ER 图

text

```
┌──────────┐     1:N     ┌──────────────┐
│   User   │────────────▶│ APIKeyConfig │
└────┬─────┘             └──────────────┘
     │ 1:N
     ▼
┌──────────────┐   1:N   ┌──────────┐   1:N   ┌─────────┐
│ KnowledgeBase│────────▶│ Document │────────▶│  Chunk  │
└──────┬───────┘         └──────────┘         └─────────┘
       │ 1:N
       ▼
┌─────────────┐   1:N   ┌─────────────┐
│ ChatSession │────────▶│ ChatMessage │
└─────────────┘         └─────────────┘
```

### 3.2 表结构定义

#### User 用户表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|email|VARCHAR(255)|UNIQUE, NOT NULL|登录邮箱|
|password_hash|VARCHAR(255)|NOT NULL|bcrypt 哈希|
|storage_used|BIGINT|DEFAULT 0|已用存储空间（字节）|
|created_at|TIMESTAMP|NOT NULL|注册时间|
|updated_at|TIMESTAMP|NOT NULL|更新时间|

#### APIKeyConfig API密钥配置表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|user_id|UUID|FK → User, NOT NULL|所属用户|
|provider|ENUM|NOT NULL|openai / anthropic / moonshot|
|encrypted_key|TEXT|NOT NULL|AES-256-GCM 加密后的密文|
|base_url|VARCHAR(500)|NULLABLE|自定义接口地址（中转站）|
|is_verified|BOOLEAN|DEFAULT false|是否通过验证|
|last_verified_at|TIMESTAMP|NULLABLE|最后验证时间|
|created_at|TIMESTAMP|NOT NULL|创建时间|
|updated_at|TIMESTAMP|NOT NULL|更新时间|

#### KnowledgeBase 知识库表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|user_id|UUID|FK → User, NOT NULL|所属用户|
|name|VARCHAR(100)|NOT NULL|知识库名称|
|description|TEXT|NULLABLE|知识库描述|
|doc_count|INT|DEFAULT 0|文档数量（冗余字段，定期同步）|
|created_at|TIMESTAMP|NOT NULL|创建时间|
|updated_at|TIMESTAMP|NOT NULL|更新时间|

#### Document 文档表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|kb_id|UUID|FK → KnowledgeBase, NOT NULL|所属知识库|
|user_id|UUID|FK → User, NOT NULL|冗余字段，权限校验用|
|filename|VARCHAR(255)|NOT NULL|原始文件名|
|file_type|ENUM|NOT NULL|pdf / md / txt / docx|
|file_size|BIGINT|NOT NULL|文件大小（字节）|
|s3_key|VARCHAR(500)|NOT NULL|对象存储路径|
|status|ENUM|NOT NULL|queued / parsing / indexing / completed / failed|
|error_message|TEXT|NULLABLE|失败原因|
|page_count|INT|NULLABLE|总页数（仅 PDF）|
|chunk_count|INT|DEFAULT 0|切片数量|
|created_at|TIMESTAMP|NOT NULL|上传时间|
|updated_at|TIMESTAMP|NOT NULL|状态更新时间|

#### Chunk 文档切片表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|doc_id|UUID|FK → Document, NOT NULL|所属文档|
|user_id|UUID|FK → User, NOT NULL|冗余字段，向量隔离用|
|kb_id|UUID|FK → KnowledgeBase, NOT NULL|冗余字段，检索过滤用|
|content|TEXT|NOT NULL|切片文本内容|
|page_number|INT|NULLABLE|所在页码（仅 PDF）|
|bbox_json|JSONB|NULLABLE|坐标信息 `{"x0":,"y0":,"x1":,"y1":}`|
|chunk_index|INT|NOT NULL|在文档中的顺序编号|
|embedding|VECTOR(1536)|NOT NULL|PgVector 向量（维度取决于模型）|
|token_count|INT|NOT NULL|Token 数量|
|created_at|TIMESTAMP|NOT NULL|创建时间|

#### ChatSession 会话表

| 字段         | 类型           | 约束                           | 说明     |
| ---------- | ------------ | ---------------------------- | ------ |
| id         | UUID         | PK                           | 主键     |
| kb_id      | UUID         | FK → KnowledgeBase, NOT NULL | 所属知识库  |
| user_id    | UUID         | FK → User, NOT NULL          | 所属用户   |
| title      | VARCHAR(200) | NOT NULL                     | 会话标题   |
| created_at | TIMESTAMP    | NOT NULL                     | 创建时间   |
| updated_at | TIMESTAMP    | NOT NULL                     | 最后活跃时间 |

#### ChatMessage 消息表

|字段|类型|约束|说明|
|---|---|---|---|
|id|UUID|PK|主键|
|session_id|UUID|FK → ChatSession, NOT NULL|所属会话|
|role|ENUM|NOT NULL|user / assistant|
|content|TEXT|NOT NULL|消息内容（Markdown 格式）|
|sources_json|JSONB|NULLABLE|引用来源列表 `[{chunk_id, doc_id, filename, page, score}]`|
|token_used|INT|NULLABLE|本次消耗的 Token 数（仅 assistant）|
|created_at|TIMESTAMP|NOT NULL|发送时间|

---

## 4. 业务流程 (User Flow)

### 4.1 主流程

``` mermaid
graph TD
    A[落地页] --> B[注册/登录]
    B --> C{检查API Key}
    C -- 未配置 --> D[设置页: 填写 API Key]
    D --> E[验证Key有效性]
    E -- 失败 --> D
    E -- 成功 --> F[知识库仪表盘]
    C -- 已配置 --> F
    F --> G[新建知识库]
    G --> H[上传文档]
    H --> I[等待解析完成]
    I -- 失败 --> J[查看失败原因, 重新上传]
    I -- 成功 --> K[进入对话界面]
    K --> L[提问]
    L --> M[流式回答 + 引用标注]
    M --> N[点击引用角标]
    N --> O[右侧分屏打开PDF, 跳转高亮]
```

### 4.2 文档处理流程


``` mermaid
graph LR
    A[用户上传文件] --> B[前端校验: 格式/大小/配额]
    B --> C[上传至文件存储]
    C --> D[写入 Document 表, status=queued]
    D --> E[推入任务队列]
    E --> F[Worker: 下载文件并解析]
    F --> G[Worker: 文本切片]
    G --> H[Worker: 调用 Embedding API]
    H --> I[Worker: 向量写入 PgVector]
    I --> J[更新 status=completed]
    F -- 解析失败 --> K[更新 status=failed, 写入 error_message]
    H -- Key余额不足 --> K
```

---

## 5. 功能详情 (Functional Specifications)

### 模块 A：用户与鉴权系统

|ID|功能名称|优先级|功能描述|验收标准|开发备注|
|---|---|---|---|---|---|
|A-01|邮箱注册|P0|邮箱+密码注册，密码要求≥8位含大小写|注册成功后自动登录并跳转仪表盘|bcrypt 哈希存储密码|
|A-02|邮箱登录|P0|邮箱+密码登录，JWT Token 鉴权|Token 有效期 7 天，过期需重新登录|Access Token + Refresh Token|
|A-03|登出|P0|清除本地 Token|跳转至登录页|前端清除 localStorage|
|A-04|API Key 添加|P0|支持填写 Key + 选择 Provider + 可选 Base URL|保存成功后前端显示脱敏 Key（`sk-****...7x2F`）|AES-256-GCM 加密，密钥通过环境变量注入|
|A-05|API Key 修改|P0|可更换 Key / 修改 Base URL|修改后自动触发重新验证|—|
|A-06|API Key 删除|P0|删除已保存的 Key|物理删除，不做软删除；删除后提示"对话和上传功能将不可用"|—|
|A-07|Key 有效性验证|P1|保存 Key 时自动发送极简请求测试连通性|3秒内返回结果；成功显示绿色✓，失败显示红色✗+错误原因|调用 `/v1/models` 接口或发送 "Hi"|
|A-08|配额检查|P0|上传/创建时校验是否超出限额|前端拦截+后端双重校验；超限时弹窗提示当前用量和上限|—|

### 模块 B：知识库与文档管理

|ID|功能名称|优先级|功能描述|验收标准|开发备注|
|---|---|---|---|---|---|
|B-01|创建知识库|P0|填写名称（必填）和描述（选填）|创建后跳转至知识库详情页|校验同名|
|B-02|知识库列表|P0|卡片式展示所有知识库|每张卡片显示：名称、描述、文档数、创建时间|—|
|B-03|编辑知识库|P0|修改名称和描述|即时保存|—|
|B-04|删除知识库|P0|二次确认后删除|级联删除：库内文档 + S3 文件 + 向量数据 + 关联会话|异步执行级联删除|
|B-05|文件上传|P0|支持拖拽和点击上传 PDF/MD/TXT/DOCX|显示上传进度条；上传完成后立即在列表出现（status=queued）|前端限制格式和大小|
|B-06|批量上传|P1|一次选择多个文件|最多同时上传 5 个文件|—|
|B-07|文档列表|P0|列表展示知识库内所有文档|每行显示：文件名、类型图标、大小、状态标签、上传时间|—|
|B-08|解析状态显示|P0|实时展示文档处理状态|状态标签颜色：灰(queued)、蓝(parsing/indexing)、绿(completed)、红(failed)|前端每 3 秒轮询；完成后停止轮询|
|B-09|失败原因查看|P0|点击失败状态可查看原因|Tooltip 或弹窗显示 error_message|—|
|B-10|删除文档|P0|删除单个文档|同时删除 S3 文件 + 对应 Chunk 向量|—|
|B-11|重新解析|P1|对失败的文档重新触发解析|状态重置为 queued|—|
|B-12|切片调试|P2|点击已完成文档查看 Chunk 列表|显示每个 Chunk 的序号、内容预览（前100字）、页码|方便排查检索不准问题|

### 模块 C：对话与溯源

| ID   | 功能名称       | 优先级 | 功能描述                      | 验收标准                                                     | 开发备注                              |
| ---- | ---------- | --- | ------------------------- | -------------------------------------------------------- | --------------------------------- |
| C-01 | 新建会话       | P0  | 在知识库内新建对话                 | 默认标题为首条提问的前 20 个字                                        | —                                 |
| C-02 | 会话历史列表     | P0  | 左侧边栏展示历史会话                | 按最后活跃时间倒序；点击切换会话内容                                       | —                                 |
| C-03 | 删除会话       | P0  | 删除单个会话                    | 级联删除所有消息                                                 | —                                 |
| C-04 | 流式对话       | P0  | 打字机效果输出回答                 | 首 Token 响应 < 3 秒（网络正常时）；中途可点击"停止生成"                      | SSE 实现                            |
| C-05 | 引用标注渲染     | P0  | LLM 回答中 `[n]` 渲染为可点击的上标链接 | 鼠标悬浮显示来源文件名和页码的 Tooltip                                  | 正则匹配 `[数字]`                       |
| C-06 | 分屏 文档阅读器   | P0  | 左侧面板嵌入文档 阅读器              | 支持缩放、翻页、滚动                                               | react-pdf 或 react-pdf-highlighter |
| C-07 | 引用跳转 + 高亮  | P0  | 点击 `[n]`，右侧加载对应文档 并跳转高亮   | ① 自动滑出右侧面板 ② 跳转到指定页码 ③ 在 BBox 坐标处绘制黄色半透明高亮框 ④ 响应时间 < 1 秒 | PDF 通过 Presigned URL 加载           |
| C-08 | 跨文档引用切换    | P0  | 同一回答引用不同文档时点击不同角标         | 右侧面板顶部显示当前文档名；切换引用时自动加载新文档                               | —                                 |
| C-09 | 非 PDF 引用展示 | P1  | TXT/MD/DOCX 的引用展示         | 右侧面板显示纯文本片段，关键文字高亮                                       | 降级方案                              |
| C-10 | 对话导出       | P1  | 导出当前会话为 Markdown 文件       | 包含问答内容和引用来源列表                                            | —                                 |
| C-11 | 空知识库拦截     | P0  | 知识库无已完成文档时不可发起对话          | 输入框禁用，显示提示"请先上传并完成至少一个文档的解析"                             | —                                 |

### 模块 D：部署与运维

| ID   | 功能名称              | 优先级 | 功能描述                 | 验收标准                                 | 开发备注                                 |
| ---- | ----------------- | --- | -------------------- | ------------------------------------ | ------------------------------------ |
| D-01 | Docker Compose 编排 | P0  | 一键拉起全部服务             | `docker-compose up -d` 后 5 分钟内所有服务健康 | 包含: web, api, postgres, redis, minio |
| D-02 | 环境变量配置            | P0  | 通过 `.env` 文件配置所有外部依赖 | 支持配置：DB连接、文件存储地址、加密密钥、是否开放注册         | 提供 `.env.example`                    |
| D-03 | README 文档         | P0  | 完整的部署和使用指南           | 包含：快速开始、环境要求、配置说明、常见问题               | —                                    |
| D-04 | 健康检查接口            | P1  | `/health` 接口检查各服务状态  | 返回 DB、文件存储连接状态                       | —                                    |

---

## 6. RAG 引擎策略 (RAG Strategy)

### 6.1 文档解析配置

| 参数            | 值          | 说明                                       |
| ------------- | ---------- | ---------------------------------------- |
| 解析工具          | -          | PDF 解析，可提取文字+坐标                          |
| DOCX 解析       | -          | Word 文档解析，可提取文字+坐标                       |
| 切片策略          | 递归字符切片     | LangChain RecursiveCharacterTextSplitter |
| chunk_size    | 500 tokens | 每个切片的目标大小                                |
| chunk_overlap | 50 tokens  | 相邻切片重叠部分                                 |
| 最小切片长度        | 50 tokens  | 低于此长度的切片合并到前一个                           |

### 6.2 检索策略

| 参数           | 值                 | 说明                  |
| ------------ | ----------------- | ------------------- |
| Embedding 模型 | text-embedding-v3 | 使用用户的 OpenAI Key 调用 |
| 向量维度         | 1536              | 与 ada-002 一致        |
| 检索 Top-K     | 5                 | 初步检索返回 5 个最相似切片     |
| 相似度阈值        | 0.70              | 低于此分数的切片丢弃          |
| 检索范围         | 当前知识库内所有已完成文档     | 按 kb_id 过滤          |

### 6.3 Prompt 策略

#### System Prompt
```
你是一个基于用户私有文档的知识库问答助手。请严格遵守以下规则：

1. **仅基于下方提供的【参考资料】回答用户问题**。如果参考资料中没有相关信息，请明确回复："根据已有文档，未找到与此问题相关的内容。"，不要编造或推测。

2. **必须在回答中使用引用标注**，格式为 [n]（n 为参考资料的序号），插入在对应观点或事实之后。

3. 在回答末尾，附上引用来源列表，格式如下：
   ---
   **参考来源：**
   [1] 《文档名》第X页
   [2] 《文档名》第Y页

4. 回答语言应与用户提问的语言一致。

5. 如果用户的问题模糊，请先简要回答，再建议用户如何更精确地提问。

【参考资料】
{context}
```

#### Context 拼接规则
```
每个检索到的 Chunk 按以下格式拼接：

[1] 来源：《{filename}》第{page_number}页
{chunk_content}

[2] 来源：《{filename}》第{page_number}页
{chunk_content}

...
```

---

## 7. 界面设计规范 (UI Specification)

### 7.1 页面结构总览

text

```
页面地图：
├── / (落地页)
├── /login (登录)
├── /register (注册)
├── /dashboard (知识库仪表盘) ← 登录后默认页
├── /note/:session_id (对话界面 - 含分屏)
└── /settings (设置页 - API Key 管理)
```

### 7.2 核心页面线框描述

#### 页面一：知识库仪表盘 (`/dashboard`)
```
┌─────────────────────────────────────────────────┐
│  Logo    Note Plus           [设置⚙]  [头像▼]  │  ← 顶部导航
├─────────────────────────────────────────────────┤
│                                                  │
│  我的知识库                     [+ 新建知识库]    │
│                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 📚       │  │ 📚       │  │ 📚       │       │  ← 卡片网格
│  │ 毕业论文  │  │ 机器学习  │  │ 经济学   │       │     多列布局
│  │ 12 篇文档 │  │ 5 篇文档  │  │ 8 篇文档  │       │
│  │ 2025-1-10│  │ 2025-1-8 │  │ 2025-1-5 │       │
│  │ [进入] [⋯]│  │ [进入] [⋯]│  │ [进入] [⋯]│       │
│  └──────────┘  └──────────┘  └──────────┘       │
│                                                  │
│  存储用量: 87MB / 200MB  ████████░░ 43.5%       │  ← 底部用量提示
└─────────────────────────────────────────────────┘
```

#### 页面二：对话 + 分屏溯源界面 (`/note/:session_id`)

```
┌─────────────────────────────────────────────────────────────────┐
│  ← 返回知识库    毕业论文 > 会话: Transformer原理    [导出📥]    │
├────────────┬────────────────────────┬────────────────────────────┤
│ 文档列表    │     对话区域 (左侧)     │     文档阅读器 (右侧)       │
│            │                        │    ← 默认隐藏，点击引用展开  │
│           │  👤 Transformer的核心    │  ┌────────────────────┐   │
│ • 文档1    │     创新是什么？         │  │ transformer.pdf    │   │
│ • 文档2    │                        │  │ 第3页 / 共12页       │   │
│ • 文档3    │  🤖 Transformer的核心   │  │                    │   │
│            │     创新在于自注意力     │  │  ┌──────────────┐  │   │
│            │     机制[1]，它摒弃了    │  │  │ ██████████  │  │   │  ← 黄色高亮
│            │     传统的循环结构[2]    │  │  │ ██ 高亮文本 ██ │  │   │
│            │     ...                │  │  │ ██████████  │  │   │
│            │                        │  │  └──────────────┘  │   │
│            │     ---                │  │                    │   │
│            │     参考来源:           │  │                    │   │
│            │     [1] transformer.pdf│  │                    │   │
│            │         第3页          │  │                    │   │
│            │     [2] attention.pdf  │  │                    │   │
│            │         第7页          │  │                    │   │
│            │                        │  └────────────────────┘   │
│            │ ┌──────────────────┐   │                           │
│            │ │ 请输入问题...  [➤]│   │                           │
│            │ └──────────────────┘   │                           │
├────────────┴────────────────────────┴────────────────────────────┤
│  宽度比例: 侧边栏15% | 对话区50% | 阅读器35%（展开时）         │
└─────────────────────────────────────────────────────────────────┘
```

#### 页面三：设置页 (`/settings`)
```
┌─────────────────────────────────────────────────┐
│  ← 返回    设置                                  │
├─────────────────────────────────────────────────┤
│                                                  │
│  API Key 配置                                    │
│  ⚠️ 您的 Key 仅用于调用 AI 服务，加密存储，        │
│     平台无法查看明文                               │
│                                                  │
│  ┌─────────────────────────────────────────┐    │
│  │ 服务商:  [OpenAI        ▼]               │    │
│  │                                         │    │
│  │ API Key: [sk-****************************]│    │
│  │                                         │    │
│  │ Base URL (选填):                         │    │
│  │ [https://api.openai.com/v1            ] │    │  ← 默认值灰色预填
│  │  ℹ️ 如使用中转服务，请修改此地址            │    │
│  │                                         │    │
│  │ 状态:  ✅ 已验证 (2025-01-10 14:30)      │    │
│  │                                         │    │
│  │ [重新验证]  [删除Key]  [保存修改]          │    │
│  └─────────────────────────────────────────┘    │
│                                                  │
│  ─────────────────────────────────────────       │
│                                                  │
│  账户信息                                        │
│  邮箱: user@example.com                          │
│  注册时间: 2025-01-01                             │
│  存储用量: 87MB / 200MB                           │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 7.3 关键交互规则

| 交互场景              | 行为定义                                 |
| ----------------- | ------------------------------------ |
| 右侧文档 面板默认状态       | **隐藏**。对话区占满右侧全部空间                   |
| 触发展开              | 点击任意引用 `[n]`，面板从右侧滑出，动画 300ms        |
| 关闭面板              | 点击面板左上角 ✕ 或再次点击同一引用                  |
| 切换引用来自不同文档        | 右侧直接替换加载新文档，顶部文件名更新                  |
| 同一文档 不同页引用        | 仅跳转页码和高亮位置，不重新加载                     |
| 移动端（屏幕宽度 < 768px） | MVP 不做移动端适配；对话可用但隐藏分屏功能，引用改为弹窗展示文本片段 |
| 跨知识库切换            | 必须返回仪表盘重新选择，不支持跨库问答                  |
| 对话中上传新文档          | 支持。                                  |

---

## 8. 异常处理规范 (Error Handling)

### 8.1 API Key 相关异常

| 场景           | 触发条件                             | 后端处理                             | 前端表现                                 |
| ------------ | -------------------------------- | -------------------------------- | ------------------------------------ |
| Key 未配置      | 用户未保存任何 Key                      | 返回 403 + error code `NO_API_KEY` | 全局 Banner："请先配置 API Key" + 跳转设置页按钮   |
| Key 无效       | OpenAI 返回 401 Unauthorized       | 返回 401 + 错误详情                    | Toast："API Key 无效或已过期，请检查设置"         |
| Key 余额不足     | OpenAI 返回 429 insufficient_quota | 中断当前任务；标记 Key 为 `unverified`     | Toast："API Key 余额不足，请充值后重试"          |
| Key 频率限制     | OpenAI 返回 429 rate_limit         | 自动重试 1 次（间隔 5s）；仍失败则抛错           | Toast："请求过于频繁，请稍后重试"                 |
| Base URL 不可达 | 网络超时（10s）                        | 返回 408 Timeout                   | Toast："无法连接到 API 服务，请检查 Base URL 设置" |

### 8.2 文档处理异常

| 场景           | 触发条件                         | 后端处理                                     | 前端表现                                   |
| ------------ | ---------------------------- | ---------------------------------------- | -------------------------------------- |
| 加密 PDF       | PyMuPDF 抛出 password required | status=failed, error="PDF 已加密，请上传未加密版本"  | 文档列表显示红色标签，hover 查看原因                  |
| 扫描件 PDF      | 解析后文本为空或极少                   | status=failed, error="PDF 为扫描件，暂不支持 OCR" | 同上                                     |
| 文件损坏         | 解析抛出异常                       | status=failed, error="文件损坏，无法解析"         | 同上                                     |
| Embedding 失败 | API 调用失败                     | 重试 2 次；仍失败则 status=failed + 具体原因         | 同上                                     |
| 上传超限         | 达到文件数/容量上限                   | 返回 413 + 当前用量信息                          | 弹窗："存储空间已满（已用 200MB/200MB），请删除部分文档后重试" |

### 8.3 对话异常

|场景|触发条件|后端处理|前端表现|
|---|---|---|---|
|知识库无文档|0 个 completed 文档|返回 400 `NO_COMPLETED_DOCS`|发送按钮禁用 + 提示"请先上传文档"|
|检索结果为空|所有 Chunk 相似度 < 0.70|仍调用 LLM 但 context 为空|LLM 按 Prompt 回复"未找到相关内容"|
|流式中断|网络断开或 API 超时|SSE 连接断开|保留已接收内容 + 显示"网络中断，点击重试"按钮|
|回答生成中用户刷新|用户刷新页面|SSE 连接断开，已生成部分不保存|重新加载后显示历史消息（不含未完成的）|
|上下文过长|Chunk 拼接超过模型窗口|截断最低分数的 Chunk|正常返回，不提示用户|

### 8.4 通用异常

|场景|HTTP Code|前端表现|
|---|---|---|
|未登录访问|401|跳转登录页|
|无权限（访问他人资源）|403|Toast："无权访问该资源"|
|资源不存在|404|404 页面|
|服务端内部错误|500|Toast："服务异常，请稍后重试" + 自动上报错误日志|
|服务不可用|503|全屏错误页："服务维护中，请稍后访问"|

---

## 9. 安全设计 (Security)

### 9.1 API Key 安全

|安全措施|实现方式|
|---|---|
|传输加密|全链路 HTTPS (TLS 1.2+)，前端不在 URL/Cookie 中传递 Key|
|存储加密|AES-256-GCM 对称加密，加密密钥通过环境变量 `ENCRYPTION_KEY` 注入，不存数据库|
|前端展示|仅显示脱敏格式：`sk-xxxx...xxxx`（首4末4位）|
|删除策略|物理删除，不做软删除，从数据库中彻底移除|
|后端使用|仅在调用 LLM API 时内存中解密，用完即释放，不写入日志|
|审计日志|记录 Key 的创建、修改、删除操作（不记录 Key 内容）|

### 9.2 数据隔离

|隔离层|实现方式|
|---|---|
|文件隔离|S3 路径规则：`/{user_id}/{kb_id}/{doc_id}/{filename}`；访问通过 Presigned URL（有效期 15 分钟）|
|向量隔离|PgVector 查询时必须携带 `WHERE user_id = ? AND kb_id = ?` 条件|
|API 权限校验|每个接口都校验当前 JWT 用户是否为资源的 owner|
|级联安全|删除用户时级联删除所有数据（GDPR 合规）|

### 9.3 Web 安全

|防护项|实现方式|
|---|---|
|XSS|前端使用 React（默认转义）；后端对用户输入做 sanitize|
|CSRF|JWT 放在 HTTP-only Cookie 或 Authorization Header（不用 Cookie 则天然免疫）|
|SQL 注入|ORM 参数化查询（SQLAlchemy），禁止拼接 SQL|
|速率限制|全局：100 次/分钟/IP；对话接口：10 次/分钟/用户；上传接口：5 次/分钟/用户|
|文件上传安全|校验 MIME Type + 文件头 Magic Number；禁止可执行文件|
|密码安全|bcrypt 哈希，cost factor ≥ 12；密码要求 ≥ 8 位|

---

## 10. 非功能需求 (Non-Functional Requirements)

### 10.1 性能要求

|指标|目标值|测量方式|
|---|---|---|
|页面首屏加载|< 2 秒|Lighthouse|
|文件上传完成（不含解析）|10MB 文件 < 5 秒|正常网络环境|
|文档解析+索引|10MB PDF < 120 秒|后台异步，不阻塞前端|
|对话首 Token 响应|< 3 秒|用户按下回车到首个字符出现|
|引用跳转+高亮|< 1 秒|点击 [n] 到 PDF 高亮显示完成|
|MVP 并发支持|100 并发用户|压力测试|

### 10.2 可用性要求

|指标|目标值|
|---|---|
|SaaS 可用性|99.5%（月度）|
|数据持久性|不丢失用户上传的文件和对话历史|
|备份策略|PostgreSQL 每日自动备份，保留 7 天|

### 10.3 可观测性

|维度|实现方案|
|---|---|
|日志|结构化 JSON 日志，包含 `user_id`、`request_id`、`timestamp`；日志级别：INFO/WARN/ERROR|
|关键指标监控|API 响应时间 P95、任务队列深度、解析成功率、存储用量|
|告警|解析失败率 > 10% → 告警；存储总量 > 80% → 告警；API 5xx 率 > 5% → 告警|
|错误追踪|接入 Sentry 或类似服务，自动收集前后端异常|

### 10.4 兼容性

|维度|要求|
|---|---|
|浏览器|Chrome 90+, Firefox 90+, Safari 15+, Edge 90+|
|屏幕分辨率|最小 1280×720；推荐 1920×1080|
|移动端|MVP 不做移动端适配，确保不报错但不保证体验|

---

## 11. 核心 API 接口契约 (API Contract)

> 前后端并行开发的依据。所有接口前缀：`/api/v1`

### 11.1 鉴权相关

#### POST `/auth/register`

JSON

```
// Request
{
  "email": "user@example.com",
  "password": "MyPass123"
}

// Response 201
{
  "user_id": "uuid",
  "email": "user@example.com",
  "access_token": "jwt_token",
  "refresh_token": "refresh_token"
}

// Error 409
{
  "error": "EMAIL_EXISTS",
  "message": "该邮箱已注册"
}
```

#### POST `/auth/login`

JSON

```
// Request
{
  "email": "user@example.com",
  "password": "MyPass123"
}

// Response 200
{
  "access_token": "jwt_token",
  "refresh_token": "refresh_token"
}

// Error 401
{
  "error": "INVALID_CREDENTIALS",
  "message": "邮箱或密码错误"
}
```

### 11.2 API Key 管理

#### POST `/settings/api-keys`

JSON

```
// Request
{
  "provider": "openai",
  "api_key": "sk-xxxxxxxxxxxxxxxx",
  "base_url": "https://api.openai.com/v1"  // 可选
}

// Response 201
{
  "id": "uuid",
  "provider": "openai",
  "masked_key": "sk-xxxx...xx7F",
  "base_url": "https://api.openai.com/v1",
  "is_verified": true,
  "created_at": "2025-01-10T14:30:00Z"
}
```

#### GET `/settings/api-keys`

JSON

```
// Response 200
{
  "keys": [
    {
      "id": "uuid",
      "provider": "openai",
      "masked_key": "sk-xxxx...xx7F",
      "base_url": "https://api.openai.com/v1",
      "is_verified": true,
      "last_verified_at": "2025-01-10T14:30:00Z"
    }
  ]
}
```

#### DELETE `/settings/api-keys/:id`

JSON

```
// Response 204 (No Content)
```

### 11.3 知识库管理

#### POST `/knowledge-bases`

JSON

```
// Request
{
  "name": "毕业论文资料",
  "description": "Transformer相关论文集合"
}

// Response 201
{
  "id": "uuid",
  "name": "毕业论文资料",
  "description": "Transformer相关论文集合",
  "doc_count": 0,
  "created_at": "2025-01-10T14:30:00Z"
}
```

#### GET `/knowledge-bases`

JSON

```
// Response 200
{
  "knowledge_bases": [
    {
      "id": "uuid",
      "name": "毕业论文资料",
      "description": "...",
      "doc_count": 12,
      "created_at": "2025-01-10T14:30:00Z"
    }
  ],
  "storage_used": 91226112,
  "storage_limit": 209715200
}
```

#### DELETE `/knowledge-bases/:id`

JSON

```
// Response 202 (Accepted, 级联删除异步执行)
{
  "message": "知识库删除中，相关文件和数据将在后台清理"
}
```

### 11.4 文档管理

#### POST `/knowledge-bases/:kb_id/documents/upload`

text

```
// Request: multipart/form-data
// Field: file (binary)

// Response 201
{
  "id": "uuid",
  "filename": "transformer.pdf",
  "file_type": "pdf",
  "file_size": 2412544,
  "status": "queued",
  "created_at": "2025-01-10T14:30:00Z"
}

// Error 413
{
  "error": "STORAGE_LIMIT_EXCEEDED",
  "message": "存储空间不足",
  "current_usage": 198000000,
  "limit": 209715200
}
```

#### GET `/knowledge-bases/:kb_id/documents`

JSON

```
// Response 200
{
  "documents": [
    {
      "id": "uuid",
      "filename": "transformer.pdf",
      "file_type": "pdf",
      "file_size": 2412544,
      "status": "completed",
      "page_count": 12,
      "chunk_count": 47,
      "error_message": null,
      "created_at": "2025-01-10T14:30:00Z"
    },
    {
      "id": "uuid",
      "filename": "corrupted.pdf",
      "file_type": "pdf",
      "file_size": 512000,
      "status": "failed",
      "page_count": null,
      "chunk_count": 0,
      "error_message": "PDF 已加密，请上传未加密版本",
      "created_at": "2025-01-10T14:35:00Z"
    }
  ]
}
```

#### GET `/documents/:doc_id/presigned-url`

JSON

```
// Response 200
{
  "url": "https://s3.../transformer.pdf?X-Amz-Signature=...",
  "expires_in": 900
}
```

### 11.5 对话

#### POST `/knowledge-bases/:kb_id/chat/sessions`

JSON

```
// Request
{
  "title": ""  // 可选，为空则自动生成
}

// Response 201
{
  "id": "uuid",
  "kb_id": "uuid",
  "title": "新会话",
  "created_at": "2025-01-10T14:30:00Z"
}
```

#### GET `/knowledge-bases/:kb_id/chat/sessions`

JSON

```
// Response 200
{
  "sessions": [
    {
      "id": "uuid",
      "title": "Transformer的核心创新",
      "updated_at": "2025-01-10T15:00:00Z"
    }
  ]
}
```

#### POST `/chat/sessions/:session_id/messages` (SSE)

JSON

```
// Request
{
  "content": "Transformer的核心创新是什么？"
}

// Response: text/event-stream
// --- 流式事件 ---

event: chunk
data: {"content": "Transformer"}

event: chunk
data: {"content": "的核心"}

event: chunk
data: {"content": "创新在于"}

// ... 持续输出 ...

event: sources
data: {
  "sources": [
    {
      "index": 1,
      "chunk_id": "uuid",
      "doc_id": "uuid",
      "filename": "transformer.pdf",
      "page_number": 3,
      "bbox": {"x0": 72, "y0": 320, "x1": 540, "y1": 410},
      "score": 0.92,
      "text_preview": "The dominant sequence transduction models are based on..."
    },
    {
      "index": 2,
      "chunk_id": "uuid",
      "doc_id": "uuid",
      "filename": "attention.pdf",
      "page_number": 7,
      "bbox": {"x0": 72, "y0": 150, "x1": 540, "y1": 230},
      "score": 0.87,
      "text_preview": "Self-attention, sometimes called intra-attention..."
    }
  ]
}

event: done
data: {
  "message_id": "uuid",
  "token_used": 1250
}
```

#### GET `/chat/sessions/:session_id/messages`

JSON

```
// Response 200
{
  "messages": [
    {
      "id": "uuid",
      "role": "user",
      "content": "Transformer的核心创新是什么？",
      "created_at": "2025-01-10T15:00:00Z"
    },
    {
      "id": "uuid",
      "role": "assistant",
      "content": "Transformer的核心创新在于自注意力机制[1]...",
      "sources_json": [
        {
          "index": 1,
          "chunk_id": "uuid",
          "doc_id": "uuid",
          "filename": "transformer.pdf",
          "page_number": 3,
          "bbox": {"x0": 72, "y0": 320, "x1": 540, "y1": 410},
          "score": 0.92
        }
      ],
      "token_used": 1250,
      "created_at": "2025-01-10T15:00:05Z"
    }
  ]
}
```

---

## 12. 技术选型 (Technical Stack)

|层级|选型|版本要求|选型理由|
|---|---|---|---|
|**前端框架**|Next.js (React)|14+|SSR/SSG 支持、App Router、生态成熟|
|**UI 样式**|TailwindCSS + shadcn/ui|—|开发效率高、组件丰富|
|**PDF 渲染**|react-pdf-highlighter|—|专门解决 PDF 高亮选中问题|
|**后端框架**|Python FastAPI|0.100+|异步支持好、自动文档、类型安全|
|**ORM**|SQLAlchemy 2.0|—|成熟稳定|
|**任务队列**|Celery + Redis|—|文档解析异步处理|
|**RAG 框架**|LangChain|—|生态成熟、便于切换模型|
|**PDF 解析**|PyMuPDF (fitz)|—|可提取文字+坐标(BBox)|
|**关系型 DB**|PostgreSQL|15+|—|
|**向量 DB**|PgVector (PG 插件)|—|减少运维成本，只维护一个数据库|
|**文件存储**|AWS S3 / MinIO|—|S3 协议兼容|
|**容器化**|Docker + Docker Compose|—|标准化部署|

### 12.1 语言支持说明

|语言|支持程度|说明|
|---|---|---|
|英文|完整支持|OpenAI Embedding 对英文效果最佳|
|中文|支持|OpenAI ada-002 对中文支持尚可；如需更优效果，P1 阶段支持切换 `bge-large-zh`|
|其他语言|基本支持|取决于 Embedding 模型能力|

---

## 13. 开发与交付计划 (Roadmap)

### Phase 1：基础架构（Week 1-2）

|任务|交付物|负责端|
|---|---|---|
|Docker Compose 编排跑通|全栈可本地启动|Full-Stack|
|Next.js 项目初始化 + 路由 + 布局|页面骨架|前端|
|FastAPI 项目初始化 + DB 迁移|数据库表创建完成|后端|
|用户注册/登录/JWT|可注册登录|前后端|
|API Key CRUD + 加密存储|可保存和查看脱敏 Key|前后端|

**里程碑：** 能注册登录、能保存 API Key。

### Phase 2：知识库核心（Week 3-4）

|任务|交付物|负责端|
|---|---|---|
|知识库 CRUD + 仪表盘页面|可创建/删除知识库|前后端|
|文件上传至 S3/MinIO|文件可上传和存储|前后端|
|Celery 任务队列搭建|异步任务可执行|后端|
|PDF 解析 + 切片 + BBox 提取|Chunk 含页码和坐标|后端|
|Embedding + 向量入库|PgVector 可检索|后端|
|解析状态机 + 前端轮询|列表显示实时状态|前后端|

**里程碑：** 上传 PDF 后能看到"索引完成"状态。

### Phase 3：对话闭环（Week 5-6）

|任务|交付物|负责端|
|---|---|---|
|RAG 检索 + Prompt 拼接|基础问答可用|后端|
|SSE 流式输出|打字机效果|前后端|
|引用标注 `[n]` 渲染|可点击的上标链接|前端|
|会话管理（新建/历史/删除）|会话列表可用|前后端|
|异常处理（Key 失效、余额不足等）|错误提示完整|前后端|

**里程碑：** 可以完成完整的上传→提问→获取带引用回答的流程。

### Phase 4：溯源高亮（Week 7-8）

|任务|交付物|负责端|
|---|---|---|
|react-pdf-highlighter 集成|PDF 阅读器可用|前端|
|Presigned URL 生成|安全加载 PDF|后端|
|BBox 坐标 → 前端高亮映射|点击引用可跳转高亮|前端|
|分屏交互（展开/折叠/切换文档）|交互流畅|前端|
|非 PDF 格式降级展示|TXT/MD 引用可查看|前端|

**里程碑：** 核心差异化功能可用。

### Phase 5：发布准备（Week 9-10）

|任务|交付物|负责端|
|---|---|---|
|安全审计 + 渗透测试|安全报告|后端|
|性能压测|性能报告|后端|
|Self-Host 部署文档|README + 部署指南|Full-Stack|
|落地页设计与开发|产品介绍页|前端|
|Bug 修复 + 体验打磨|—|全员|

**里程碑：** GitHub 开源发布 + SaaS 上线。

---

## 14. 风险与应对策略

|风险|影响|概率|应对策略|
|---|---|---|---|
|**BBox 坐标精度不够**|高亮位置偏移，核心体验受损|中|PyMuPDF 提取精度较高；若不够则降级为页面级跳转（不画框）|
|**Embedding 成本引发用户投诉**|用户不理解上传文档也要花钱|中|上传前明确提示预估 Token 消耗（如"本文档预计消耗约 0.02 美元"）|
|**OpenAI API 国内不稳定**|国内用户体验差|高|支持自定义 Base URL（中转站）；MVP 服务器部署在香港/新加坡|
|**PDF 格式千差万别**|部分 PDF 解析失败率高|中|提供明确错误信息；优先保证学术论文 PDF 的解析质量|
|**SaaS 存储成本增长**|用户增长后 S3 费用不可控|低|严格的配额限制；定期清理长期不活跃账户的数据（需提前通知）|
|**开源后被竞品抄袭**|—|高|保持迭代速度；核心壁垒在社区和品牌，不在代码|

---

## 15. 后续迭代方向（P1/P2，不在 MVP 范围内）

|优先级|功能|说明|
|---|---|---|
|P1|**Embedding 模型可选**|支持 bge-large-zh 等本地模型，降低成本并提升中文效果|
|P1|**暗色模式**|研究者深夜使用场景多|
|P1|**对话导出为 Markdown**|方便写论文时引用|
|P1|**多模型切换**|对话时可选 GPT-4 / GPT-3.5 / Claude|
|P2|**知识库共享（只读链接）**|课题组内共享|
|P2|**OCR 支持**|扫描件 PDF 识别|
|P2|**对话内容搜索**|搜索历史问答|
|P2|**Rerank 二次精排**|提升引用精度|
|P2|**Web 页面导入**|通过 URL 抓取网页内容入库|
|P2|**移动端适配**|响应式布局|



